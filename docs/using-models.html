<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Using OCR models | OCR Tutorial</title>
  <meta name="description" content="OCR-tutorial by Niko Partanen. Given during IWCLUL conference, Vienna 2020." />
  <meta name="generator" content="bookdown 0.11 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Using OCR models | OCR Tutorial" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="OCR-tutorial by Niko Partanen. Given during IWCLUL conference, Vienna 2020." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Using OCR models | OCR Tutorial" />
  
  <meta name="twitter:description" content="OCR-tutorial by Niko Partanen. Given during IWCLUL conference, Vienna 2020." />
  

<meta name="author" content="Niko Partanen" />


<meta name="date" content="2020-01-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="htr.html">
<link rel="next" href="references.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />










<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">OCR tutorial</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Prerequisites</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a></li>
<li class="chapter" data-level="3" data-path="tools.html"><a href="tools.html"><i class="fa fa-check"></i><b>3</b> Tools</a></li>
<li class="chapter" data-level="4" data-path="layout.html"><a href="layout.html"><i class="fa fa-check"></i><b>4</b> Layout analysis</a></li>
<li class="chapter" data-level="5" data-path="ground-truth.html"><a href="ground-truth.html"><i class="fa fa-check"></i><b>5</b> Ground Truth creation</a><ul>
<li class="chapter" data-level="5.1" data-path="ground-truth.html"><a href="ground-truth.html#examples"><i class="fa fa-check"></i><b>5.1</b> Examples</a></li>
<li class="chapter" data-level="5.2" data-path="ground-truth.html"><a href="ground-truth.html#summary"><i class="fa fa-check"></i><b>5.2</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="training.html"><a href="training.html"><i class="fa fa-check"></i><b>6</b> OCR Model training</a><ul>
<li class="chapter" data-level="6.1" data-path="training.html"><a href="training.html#training-calamari"><i class="fa fa-check"></i><b>6.1</b> Training Calamari</a></li>
<li class="chapter" data-level="6.2" data-path="training.html"><a href="training.html#training-tesseract"><i class="fa fa-check"></i><b>6.2</b> Training Tesseract</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="htr.html"><a href="htr.html"><i class="fa fa-check"></i><b>7</b> Handwritten text recognition</a></li>
<li class="chapter" data-level="8" data-path="using-models.html"><a href="using-models.html"><i class="fa fa-check"></i><b>8</b> Using OCR models</a><ul>
<li class="chapter" data-level="8.1" data-path="using-models.html"><a href="using-models.html#using-tesseract"><i class="fa fa-check"></i><b>8.1</b> Using Tesseract</a></li>
<li class="chapter" data-level="8.2" data-path="using-models.html"><a href="using-models.html#using-calamari"><i class="fa fa-check"></i><b>8.2</b> Using Calamari</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">OCR Tutorial</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="using-models" class="section level1">
<h1><span class="header-section-number">Chapter 8</span> Using OCR models</h1>
<p>In this section we go through with practical examples how OCR models can be used.chr</p>
<div id="using-tesseract" class="section level2">
<h2><span class="header-section-number">8.1</span> Using Tesseract</h2>
<p>Tesseract can be used as:</p>
<pre><code>tesseract image.jpg image -l kpv alto</code></pre>
<p>This works when we have language model called <code>kpv</code> in so-called Tessdata directory. Directory can also be specified as an argument. To get XML output, one can have <code>alto</code> or <code>hocr</code> in the end of the command.</p>
<p>R has <a href="https://docs.ropensci.org/tesseract/">Tesseract bindings</a> that work well.</p>
<p><a href="https://pypi.org/project/pytesseract/">Pytesseract</a> is a good option for Python. I had some problems while using different language models on it, but for layout analysis it was really convenient.</p>
</div>
<div id="using-calamari" class="section level2">
<h2><span class="header-section-number">8.2</span> Using Calamari</h2>
<p>Calamari can be used from command line, so that it is given the model and location of line images.</p>
<pre><code>calamari-predict --checkpoint path_to_model.ckpt --files your_images.*.png</code></pre>
<p>It can also be used directly from Python.</p>
<pre><code>from calamari_ocr.ocr import Predictor, create_dataset, DataSetType, DataSetMode
import tensorflow as tf

predictor = Predictor(&#39;./models/komi-latin-bin00004500.ckpt&#39;)

for prediction in predictor.predict_raw(images = line_list, progress_bar=False):
    print(prediction.sentence)
</code></pre>
<p>More complete example could look like this:</p>
<pre><code>
def read_alto(alto_file, version = 2):
    
    tree = ET.parse(alto_file)
    root = tree.getroot()

    xmlns = {&#39;alto&#39;: &#39;{http://www.loc.gov/standards/alto/ns-v&#39; + str(version) + &#39;#}&#39;}
    
    data = []

    unit = root.find(&#39;.//{alto}MeasurementUnit&#39;.format(**xmlns)).text

    max_height = root.find(&#39;.//{alto}PrintSpace&#39;.format(**xmlns)).get(&#39;HEIGHT&#39;)
    max_width = root.find(&#39;.//{alto}PrintSpace&#39;.format(**xmlns)).get(&#39;WIDTH&#39;)

    for block in root.iterfind(&#39;.//{alto}TextBlock&#39;.format(**xmlns)):
        
        block_id = block.get(&#39;ID&#39;)

        for line in block.iterfind(&#39;.//{alto}TextLine&#39;.format(**xmlns)):

            content = {}

            content[&quot;block_id&quot;] = block_id
            content[&quot;height&quot;] = line.get(&#39;HEIGHT&#39;)
            content[&quot;width&quot;] = line.get(&#39;WIDTH&#39;)
            content[&quot;top&quot;] = line.get(&#39;VPOS&#39;)
            content[&quot;left&quot;] = line.get(&#39;HPOS&#39;)
            content[&quot;unit&quot;] = unit
            content[&quot;max_height&quot;] = max_height
            content[&quot;max_width&quot;] = max_width

            line_strings = []
            for string in line.findall(&#39;./{alto}String&#39;.format(**xmlns)):
                line_strings.append(string.get(&#39;CONTENT&#39;))
            content[&quot;text&quot;] = &#39; &#39;.join(line_strings)
            
            data.append(content)
        
    return(data)

def extract_line_array(pil_image, height, width, top, left):

    cropped_example = pil_image.crop((int(left), int(top), int(left) + int(width), int(top) + int(height)))

    cropped_example_bw = cropped_example.convert(&quot;L&quot;)
    
    image_array = numpy.array(cropped_example_bw)

    image_array_binarized = binarize_array(image_array, 150)

    #image_array_binarized = Binarizer(image_array, threshold = 150, copy=False)
    
    return(image_array_binarized)

def predict_page(page_image, alto, predictor):
    
    alto_content = read_alto(alto)
    
    pil_image = Image.open(page_image)
    
    line_list = []

    for line in alto_content:
        extracted_line = extract_line_array(pil_image, line[&#39;height&#39;], line[&#39;width&#39;], line[&#39;top&#39;], line[&#39;left&#39;])
        line_list.append(extracted_line)
    
    pred_list = []
    
    for prediction in predictor.predict_raw(images = line_list, progress_bar=False):

        pred_list.append(prediction)
        
    return(pred_list)
</code></pre>
<p>Calamari returns very nicely list of confidences for each character. This info can be used, for example, to distinguish areas where the model is most confident, which seems to indicate correct script.</p>
<div class="figure">
<img src="images/calamari_script_detector.jpg" alt="Calamari used in script detection" />
<p class="caption">Calamari used in script detection</p>
</div>
<p>The model used here was quite horribly bad, but still good enough for this.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="htr.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["ocr-tutorial.pdf", "ocr-tutorial.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
